<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#121212">
    <title>基金筛选 | Fund Screener</title>
    <link rel="stylesheet" href="modern-financial-theme.css">
    <style>
        .screener-filters { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 16px; }
        .screener-filters label { font-size: 12px; color: var(--text-muted); }
        .screener-filters input, .screener-filters select {
            padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--bg-tertiary); font-size: 14px; color: var(--text-primary);
        }
        .screener-filters button { padding: 8px 20px; border-radius: 8px; background: var(--accent-primary); border: none; cursor: pointer; font-size: 14px; color: #fff; }
        .screener-filters button:hover { background: var(--accent-primary-hover); }
        .screener-result { font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }
        .screener-pagination { display: flex; align-items: center; gap: 12px; margin: 12px 0; flex-wrap: wrap; }
        .screener-pagination button { padding: 6px 14px; border-radius: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); cursor: pointer; font-size: 13px; color: var(--text-primary); }
        .screener-pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .screener-pagination span { font-size: 13px; color: var(--text-muted); }
        .screener-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .screener-table th, .screener-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color-light); }
        .screener-table th { background: var(--bg-tertiary); color: var(--accent-primary); }
        .screener-table a { color: var(--primary); text-decoration: none; }
        .screener-table a:hover { text-decoration: underline; }
        .fund-links { font-size: 11px; color: var(--text-muted); margin-left: 6px; }
        .fund-links a { margin-right: 6px; }
        .fund-links .copy-btn { cursor: pointer; border: none; background: none; color: var(--primary); font-size: 11px; padding: 0; }
        .fund-links .copy-btn:hover { text-decoration: underline; }
        .screener-loading { padding: 24px; text-align: center; color: var(--text-muted); }
        .screener-error { color: var(--danger); padding: 12px 0; }
    </style>
</head>
<body>
    <div id="tooltip" class="tooltip"></div>
    <nav class="nav-tabs tab-nav">
        <a href="index.html" class="nav-tab">每日对账</a>
        <a href="analysis.html" class="nav-tab">深度归因</a>
        <a href="history.html" class="nav-tab">历史回测</a>
        <a href="knowledge.html" class="nav-tab">投资字典</a>
        <a href="screener.html" class="nav-tab active">基金筛选</a>
    </nav>
    <div class="container">
        <h1 class="page-title">基金筛选 (Fund Screener)</h1>
        <section class="card">
            <h2>按条件筛选基金</h2>
            <p style="color:var(--text-muted);font-size:12px;margin:0 0 12px;">结合<a href="knowledge.html#industryHeatSection"><span class="glossary-term" data-tip="根据市场资金流向与行业轮动，量化各行业当前热度，用于辅助择时与行业配置。">行业热度</span></a>，在加仓时优先考虑热度高的行业相关基金。使用 VPN 时若主链接无法访问，可尝试备用链接或复制链接后关闭 VPN 再打开。</p>
            <div class="screener-filters">
                <div>
                    <label>基金类型</label>
                    <select id="filterType">
                        <option value="">全部</option>
                    </select>
                </div>
                <div>
                    <label>名称关键词</label>
                    <input type="text" id="filterKeyword" placeholder="如：科技、消费、医药">
                </div>
                <button type="button" id="btnSearch">筛选</button>
            </div>
            <div id="screenerResult" class="screener-result"></div>
            <div id="screenerPagination" class="screener-pagination" style="display:none;"></div>
            <div id="screenerLoading" class="screener-loading" style="display:none;">加载中…</div>
            <div id="screenerError" class="screener-error" style="display:none;"></div>
            <div id="screenerTableWrap" style="overflow-x:auto;">
                <table class="screener-table" id="screenerTable" style="display:none;">
                    <thead><tr><th><span class="glossary-term" data-tip="综合评分，结合行业热度、历史表现等维度的量化得分，用于排序筛选。">综合分</span></th><th>基金代码</th><th>基金名称</th><th>基金类型</th></tr></thead>
                    <tbody id="screenerBody"></tbody>
                </table>
            </div>
        </section>
    </div>
    <script>
        (function () {
            var PAGE_SIZE = 50;
            var fundsData = null;
            var filteredList = [];
            var currentPage = 1;
            var filterType = document.getElementById('filterType');
            var filterKeyword = document.getElementById('filterKeyword');
            var btnSearch = document.getElementById('btnSearch');
            var resultEl = document.getElementById('screenerResult');
            var paginationEl = document.getElementById('screenerPagination');
            var loadingEl = document.getElementById('screenerLoading');
            var errorEl = document.getElementById('screenerError');
            var tableEl = document.getElementById('screenerTable');
            var bodyEl = document.getElementById('screenerBody');

            function norm(f) {
                return { code: f.code || f.c, name: f.name || f.n, type: f.type || f.t, score: f.s != null ? f.s : (f.score != null ? f.score : 0) };
            }

            function loadFunds() {
                loadingEl.style.display = 'block';
                errorEl.style.display = 'none';
                fetch('funds_db.json')
                    .then(function (r) {
                        if (!r.ok) return Promise.reject('HTTP ' + r.status);
                        return r.text();
                    })
                    .then(function (text) {
                        if (text.trim().indexOf('<') === 0) return Promise.reject('未配置');
                        return JSON.parse(text);
                    })
                    .then(function (data) {
                        fundsData = data;
                        loadingEl.style.display = 'none';
                        var types = [];
                        var seen = {};
                        var funds = data.funds || [];
                        funds.forEach(function (f) {
                            var t = norm(f).type;
                            if (t && !seen[t]) { seen[t] = true; types.push(t); }
                        });
                        types.sort();
                        filterType.innerHTML = '<option value="">全部</option>' + types.map(function (t) {
                            return '<option value="' + t + '">' + t + '</option>';
                        }).join('');
                        runFilter();
                    })
                    .catch(function (err) {
                        loadingEl.style.display = 'none';
                        errorEl.style.display = 'block';
                        var msg = (err.message || err) + '';
                        if (msg === '未配置' || msg.indexOf('HTTP') === 0 || msg.indexOf('HTML') >= 0) {
                            errorEl.innerHTML = '基金数据暂未配置，不影响其他功能。如需启用，可在 workflow 中运行 <code>python data_importer.py</code> 或本地执行后部署。';
                        } else {
                            errorEl.textContent = '基金数据暂不可用: ' + msg;
                        }
                    });
            }

            function runFilter() {
                if (!fundsData || !fundsData.funds) return;
                var typeVal = (filterType.value || '').trim();
                var kw = (filterKeyword.value || '').trim().toLowerCase();
                filteredList = fundsData.funds.filter(function (f) {
                    var n = norm(f);
                    if (typeVal && n.type !== typeVal) return false;
                    if (kw && !(n.name || '').toLowerCase().includes(kw)) return false;
                    return true;
                });
                filteredList.sort(function (a, b) { return (b.s != null ? b.s : 0) - (a.s != null ? a.s : 0); });
                currentPage = 1;
                resultEl.textContent = '共 ' + filteredList.length + ' 只基金';
                renderPage();
            }

            function renderPage() {
                var totalPages = Math.max(1, Math.ceil(filteredList.length / PAGE_SIZE));
                var start = (currentPage - 1) * PAGE_SIZE;
                var pageData = filteredList.slice(start, start + PAGE_SIZE);
                bodyEl.innerHTML = pageData.map(function (f) {
                    var n = norm(f);
                    var code = (n.code || '').toString().replace(/\..*$/, '').padStart(6, '0').slice(-6);
                    var urlEast = 'https://fund.eastmoney.com/' + code + '.html';
                    var urlSina = 'https://finance.sina.com.cn/fund/quotes/' + code + '/bc.shtml';
                    var urlHexun = 'https://fund.hexun.com/' + code + '/';
                    var nameEsc = (n.name || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    var links = '<span class="fund-links">' +
                        '<a href="' + urlEast + '" target="_blank" rel="noopener noreferrer" title="天天基金">天天</a>' +
                        '<a href="' + urlSina + '" target="_blank" rel="noopener noreferrer" title="新浪财经">新浪</a>' +
                        '<a href="' + urlHexun + '" target="_blank" rel="noopener noreferrer" title="和讯基金">和讯</a>' +
                        '<button type="button" class="copy-btn" data-url="' + urlEast.replace(/"/g, '&quot;') + '" title="复制链接，可关闭 VPN 后粘贴打开">复制</button></span>';
                    var scoreVal = n.score != null ? n.score : '-';
                    return '<tr><td>' + scoreVal + '</td><td>' + n.code + '</td><td><a href="' + urlEast + '" target="_blank" rel="noopener noreferrer">' + nameEsc + '</a>' + links + '</td><td>' + (n.type || '-') + '</td></tr>';
                }).join('');
                document.querySelectorAll('.fund-links .copy-btn').forEach(function (btn) {
                    btn.onclick = function () {
                        var u = this.getAttribute('data-url');
                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(u).then(function () { btn.textContent = '已复制'; setTimeout(function () { btn.textContent = '复制'; }, 1500); }).catch(function () { window.prompt('复制链接（关闭 VPN 后粘贴打开）：', u); });
                        } else { window.prompt('复制链接（关闭 VPN 后粘贴打开）：', u); }
                    };
                });
                tableEl.style.display = filteredList.length ? 'table' : 'none';
                paginationEl.style.display = filteredList.length > PAGE_SIZE ? 'flex' : 'none';
                paginationEl.innerHTML = '<button id="pgPrev" ' + (currentPage <= 1 ? 'disabled' : '') + '>上一页</button>' +
                    '<span>第 ' + currentPage + ' / ' + totalPages + ' 页</span>' +
                    '<button id="pgNext" ' + (currentPage >= totalPages ? 'disabled' : '') + '>下一页</button>';
                var prevBtn = document.getElementById('pgPrev');
                var nextBtn = document.getElementById('pgNext');
                if (prevBtn) prevBtn.onclick = function () { if (currentPage > 1) { currentPage--; renderPage(); } };
                if (nextBtn) nextBtn.onclick = function () { if (currentPage < totalPages) { currentPage++; renderPage(); } };
            }

            btnSearch.addEventListener('click', runFilter);
            filterKeyword.addEventListener('keypress', function (e) { if (e.key === 'Enter') runFilter(); });
            document.addEventListener('mousemove', function (e) {
                var tooltip = document.getElementById('tooltip');
                if (e.target.classList && e.target.classList.contains('glossary-term')) {
                    tooltip.innerText = e.target.getAttribute('data-tip') || '';
                    tooltip.style.display = 'block';
                    var x = e.clientX + 10;
                    if (x + 290 > window.innerWidth) x = e.clientX - 300;
                    tooltip.style.left = x + 'px';
                    tooltip.style.top = (e.clientY + 10) + 'px';
                } else {
                    tooltip.style.display = 'none';
                }
            });
            loadFunds();
        })();
    </script>
    <script>if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(function(){}); }</script>
</body>
</html>
